{% extends 'base.html' %}
{% load static %}

{% block title %}V√≠ ti·ªÅn - Nh·∫≠t k√Ω giao d·ªãch{% endblock %}

{% block extra_css %}
<style>
    .transaction-item {
        border-left: 4px solid #e5e7eb;
    }
    .transaction-positive {
        border-left-color: #10b981;
    }
    .transaction-negative {
        border-left-color: #ef4444;
    }
    
    @keyframes fadeIn {
        from { opacity: 0; transform: translateY(10px); }
        to { opacity: 1; transform: translateY(0); }
    }
    
    .fade-in {
        animation: fadeIn 0.3s ease-out;
    }
</style>
{% endblock %}

{% block content %}
<div class="container mx-auto px-4 py-6">
    <!-- Header Section -->
    <div class="mb-8">
        <h1 class="text-3xl font-bold text-gray-800 mb-2">üí∞ V√≠ ti·ªÅn c·ªßa b·∫°n</h1>
        <p class="text-gray-600">Qu·∫£n l√Ω s·ªë d∆∞ v√† theo d√µi giao d·ªãch</p>
    </div>

    <!-- Balance Card -->
    <div class="bg-gradient-to-r from-blue-500 to-purple-600 rounded-xl p-6 text-white mb-8 shadow-lg">
        <div class="flex items-center justify-between">
            <div>
                <p class="text-blue-100 mb-2">S·ªë d∆∞ hi·ªán t·∫°i</p>
                <p class="text-4xl font-bold" id="balance-display">
                    {% if wallet %}
                        {{ wallet.balance|floatformat:0 }} xu
                    {% else %}
                        ƒêang t·∫£i...
                    {% endif %}
                </p>
            </div>
            <div class="text-6xl opacity-20">
                üíé
            </div>
        </div>
        
        <div class="flex items-center mt-4">
            <button onclick="refreshBalance()" 
                    class="bg-white/20 hover:bg-white/30 px-4 py-2 rounded-lg transition-colors duration-200 flex items-center gap-2">
                <span id="refresh-icon">üîÑ</span>
                <span>L√†m m·ªõi s·ªë d∆∞</span>
            </button>
        </div>
    </div>

    <!-- Quick Actions -->
    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-8">
        <a href="{% url 'caro_game:list_caro_rooms' %}" 
           class="bg-white rounded-lg p-4 shadow-md hover:shadow-lg transition-shadow duration-200 border border-gray-200">
            <div class="flex items-center gap-3">
                <span class="text-2xl">üéØ</span>
                <div>
                    <h3 class="font-semibold text-gray-800">Ch∆°i Caro</h3>
                    <p class="text-sm text-gray-600">Ki·∫øm xu qua game</p>
                </div>
            </div>
        </a>
        
        <a href="{% url 'happy_farm:farm' %}" 
           class="bg-white rounded-lg p-4 shadow-md hover:shadow-lg transition-shadow duration-200 border border-gray-200">
            <div class="flex items-center gap-3">
                <span class="text-2xl">üåæ</span>
                <div>
                    <h3 class="font-semibold text-gray-800">Happy Farm</h3>
                    <p class="text-sm text-gray-600">Thu ho·∫°ch ƒë·ªÉ ki·∫øm xu</p>
                </div>
            </div>
        </a>
        
        <div class="bg-white rounded-lg p-4 shadow-md border border-gray-200 opacity-60">
            <div class="flex items-center gap-3">
                <span class="text-2xl">üéÅ</span>
                <div>
                    <h3 class="font-semibold text-gray-800">Qu√† t·∫∑ng</h3>
                    <p class="text-sm text-gray-600">S·∫Øp ra m·∫Øt</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Transaction History -->
    <div class="bg-white rounded-lg shadow-md overflow-hidden">
        <div class="bg-gray-50 px-6 py-4 border-b">
            <h2 class="text-xl font-semibold text-gray-800 flex items-center gap-2">
                üìä L·ªãch s·ª≠ giao d·ªãch
            </h2>
        </div>
        
        <div class="p-6">
            {% if recent_transactions %}
                <div class="space-y-4" id="transaction-list">
                    {% for transaction in recent_transactions %}
                    <div class="transaction-item {% if transaction.amount > 0 %}transaction-positive{% else %}transaction-negative{% endif %} bg-gray-50 rounded-lg p-4 fade-in">
                        <div class="flex items-center justify-between">
                            <div class="flex items-center gap-3">
                                <span class="text-2xl">
                                    {% if transaction.amount > 0 %}üí∞{% else %}üí∏{% endif %}
                                </span>
                                <div>
                                    <p class="font-medium text-gray-800">{{ transaction.description }}</p>
                                    <p class="text-sm text-gray-500">{{ transaction.created_at|date:"d/m/Y H:i" }}</p>
                                </div>
                            </div>
                            <div class="text-right">
                                <p class="font-bold {% if transaction.amount > 0 %}text-green-600{% else %}text-red-600{% endif %}">
                                    {% if transaction.amount > 0 %}+{% endif %}{{ transaction.amount|floatformat:0 }} xu
                                </p>
                                <p class="text-sm text-gray-500">
                                    S·ªë d∆∞: {{ transaction.balance_after|floatformat:0 }} xu
                                </p>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
                
                <!-- Pagination (if needed) -->
                <div class="mt-6 text-center">
                    <p class="text-gray-500">Hi·ªÉn th·ªã {{ recent_transactions.count }} giao d·ªãch g·∫ßn nh·∫•t</p>
                </div>
            {% else %}
                <div class="text-center py-12">
                    <span class="text-6xl mb-4 block">üìù</span>
                    <h3 class="text-xl font-medium text-gray-800 mb-2">Ch∆∞a c√≥ giao d·ªãch n√†o</h3>
                    <p class="text-gray-600 mb-6">H√£y b·∫Øt ƒë·∫ßu ch∆°i game ƒë·ªÉ c√≥ giao d·ªãch ƒë·∫ßu ti√™n!</p>
                    <a href="{% url 'caro_game:list_caro_rooms' %}" 
                       class="inline-block bg-blue-500 hover:bg-blue-600 text-white px-6 py-3 rounded-lg transition-colors duration-200">
                        B·∫Øt ƒë·∫ßu ch∆°i ngay
                    </a>
                </div>
            {% endif %}
        </div>
    </div>
</div>

<!-- Error/Success Messages -->
<div id="message-container" class="fixed top-4 right-4 z-50"></div>

<script>
function showMessage(message, type = 'info') {
    const container = document.getElementById('message-container');
    const messageDiv = document.createElement('div');
    
    const bgColor = type === 'error' ? 'bg-red-500' : 
                   type === 'success' ? 'bg-green-500' : 'bg-blue-500';
    
    messageDiv.className = `${bgColor} text-white px-6 py-3 rounded-lg shadow-lg mb-3 fade-in`;
    messageDiv.textContent = message;
    
    container.appendChild(messageDiv);
    
    setTimeout(() => {
        messageDiv.remove();
    }, 4000);
}

function refreshBalance() {
    const refreshIcon = document.getElementById('refresh-icon');
    const balanceDisplay = document.getElementById('balance-display');
    
    refreshIcon.style.animation = 'spin 1s linear infinite';
    
    fetch('{% url "user_wallet:wallet_balance_api" %}')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                balanceDisplay.textContent = data.balance.toLocaleString() + ' xu';
                showMessage('ƒê√£ c·∫≠p nh·∫≠t s·ªë d∆∞!', 'success');
            } else {
                showMessage('Kh√¥ng th·ªÉ t·∫£i s·ªë d∆∞: ' + data.error, 'error');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showMessage('L·ªói k·∫øt n·ªëi khi t·∫£i s·ªë d∆∞', 'error');
        })
        .finally(() => {
            refreshIcon.style.animation = '';
        });
}

// CSS for spin animation
const style = document.createElement('style');
style.textContent = `
    @keyframes spin {
        from { transform: rotate(0deg); }
        to { transform: rotate(360deg); }
    }
`;
document.head.appendChild(style);
</script>
{% endblock %}
